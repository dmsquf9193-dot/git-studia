-- 메인쿼리 안에 하나 더 들어가있는 서브쿼리(소괄호 사용)
-- 입사일이 1993년 2월 19일 이면서 생일1964년 10월 24일 직원의 이름을 구하고 
-- 다시 해당 이름으로 조건을 검색해서 사번(emp_no)를 구해야 하는 경우

-- 원래 사용하던거
SELECT first_name , last_name  FROM employees
WHERE hire_date = '1993-02-19'
AND birth_date = '1964-10-24';

SELECT emp_no FROM employees
WHERE first_name = 'conrado'
AND last_name = 'serra';

-- 서브쿼리 사용 ()가 먼저 실행됨, 여기저기서 사용쌉가능
SELECT emp_no FROM employees
WHERE first_name = (SELECT first_name
                    FROM employees
                    WHERE hire_date = '1993-02-19'
                    AND birth_date = '1964-10-24')
AND last_name = (SELECT last_name  
                 FROM employees
                 WHERE hire_date = '1993-02-19'
                 AND birth_date = '1964-10-24');

-- 서브쿼리 합치기
SELECT emp_no
FROM employees
WHERE (first_name, last_name ) = (SELECT first_name, last_name 
                                  FROM employees
                                  WHERE hire_date = '1993-02-19'
                                  AND birth_date = '1964-10-24');

-- 직원중에서 emp_no가 가장 높은 직원 찾기
SELECT first_name, last_name
FROM employees
WHERE emp_no = (SELECT max(emp_no) 
                FROM employees);

SELECT max(emp_no), first_name, last_name, emp_no
FROM employees
GROUP BY first_name, last_name, emp_no
ORDER BY emp_no DESC -- 무조건 써줘야 함
LIMIT 1;

SELECT first_name, last_name
FROM employees
ORDER BY emp_no DESC 
LIMIT 1;

SELECT first_name, last_name
FROM employees
WHERE hire_date = (SELECT min(hire_date)
                   FROM employees);

SELECT min(hire_date) FROM employees;

-- 전체 평균보다 높은 연봉을 받는 직원 이름 조회
SELECT first_name, last_name 
FROM employees
WHERE emp_no = (SELECT emp_no 
                FROM salaries
                ORDER BY salary DESC 
                LIMIT 1);

-- 단일행 서브쿼리는 비교연산자 사용
SELECT first_name, last_name 
FROM employees
WHERE emp_no >= (SELECT avg(emp_no) 
                 FROM employees); -- 평균 사번보다 높은 직원의 이름만 출력
 -- 상관 서브쿼리 (개념만)  지피티가 이거 주면 버리세요.          
SELECT *
FROM employees e
WHERE hire_date > (SELECT avg(hire_date) 
                   FROM employees
                   WHERE emp_no = e.emp_no );

-- in은 서브쿼리에서 여러개의 값이 들어갈 수 있음 (다중행)
SELECT emp_no, salary
FROM salaries
WHERE salary IN (SELECT salary
                 FROM salaries s
                 ORDER BY salary DESC);

SELECT salary
FROM salaries s
ORDER BY salary DESC;

-- 다중열 다중행 서브쿼리 
SELECT *
FROM salaries s 
WHERE (emp_no, salary) IN (SELECT emp_no, max(salary)
                           FROM salaries
                           GROUP BY emp_no);

-- 현재 직급정보
SELECT emp_no, title, to_date
FROM titles 
WHERE (emp_no, to_date) IN (SELECT emp_no, MAX(to_date)
                            FROM titles
                            GROUP BY emp_no);

SELECT * FROM salaries;

-- 가장 최근까지 연봉을 받은 사람
SELECT emp_no, salary, to_date
FROM salaries
WHERE (emp_no, to_date) IN (SELECT emp_no, max(to_date)
                            FROM salaries
                            GROUP BY emp_no);

-- Q1. 첫 입사 부서를 조회하세요.
SELECT emp_no, dept_no, from_date
FROM dept_emp
WHERE (emp_no, from_date) IN (SELECT emp_no, min(from_date)
                              FROM dept_emp                        
                              GROUP BY emp_no);














